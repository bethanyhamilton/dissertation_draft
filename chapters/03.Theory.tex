\chapter{Theory} \label{ch: theory}

In this chapter, I provide an overview of the power approximation developed for this study, as well as the methodology used to derive it. Specifically, I present forms of the degrees of freedom that can be used in the power analysis of categorical moderators. 

\section{Background and Context}

The following is an overview of some concepts necessary for approximating the degrees of freedom of the cluster-robust Wald statistic for a study-level categorical moderator, which is presented at the end of this chapter.

\subsection{The \texorpdfstring{$\mathbf{D}$}{ } Matrix}

As detailed in Chapter \ref{ch:literaturereview}, \textcite{tipton2015b} proposed a test for multiple constraints where the degrees of freedom accounted for features of the design matrix, but that involves the distribution of the random matrix  $(\mathbf{C}\mathbf{V^R}\mathbf{C}')^{-1}$ (from Equation \ref{eq: omnibus test all predictors}), which is difficult to approximate. For that approximation, they used the following expressions. Let $\mathbf{\Omega}$ denote the true variance of $\mathbf{C}\bm{\hat{\beta}}-\mathbf{c}$, which is $\mathbf{\Omega} = \mathbf{C}Var(\bm{\hat{\beta}})\mathbf{C}'$. For the null hypothesis, $H_0: \mathbf{C}\mathbf{\hat{\beta}} = \mathbf{c}$, the $Q$ statistic from Equation \ref{eq: omnibus test all predictors} can be rewritten as \autocite{tipton2015b}:
\begin{equation} \label{eq: Q stat reformulation}
    Q = \mathbf{z}'\mathbf{D}^{-1}\mathbf{z},
\end{equation}
where $\mathbf{z} = \mathbf{\Omega}^{-1/2}(\mathbf{C}\bm{\hat{\beta}}-\mathbf{c})$. $\mathbf{z}$ is normally distributed with mean of $0$ and covariance $\mathbf{I}_q$. The $\mathbf{D}$ matrix is as follows:
\begin{equation} \label{eq: D matrix}
    \mathbf{D} = \bm{G}\mathbf{V}^R\bm{G}',
\end{equation}
where $\bm{G} = \bm{\Omega}^{-1/2} \bm{C}$. \textcite{tipton2015b} evaluated methods to approximate the sampling distribution of this $\mathbf{D}$ matrix specifically. 

In the context of a test of a study-level categorical moderator, with $C$ categories from a no-intercept model, let $\mu_c$ be the overall pooled effect for $c=1,\cdots, C$. Let $\bm{\mu} = \left[\mu_c\right]_{c=1}^C$ be a vector of these $\mu_c$ values. The corresponding estimator of $\bm{\mu}$ is $\bm{\hat{\mu}} = \left[\hat{\mu}_c\right]_{c=1}^C$. The estimators for each category are independent because the categories are study-level. And because the estimators for each category are independent, the diagonal of the cluster-robust variance estimator ($\bm{V}^R$; see Equation \ref{eq:RVE_VR}) can be expressed as $\bm{V}^R = \bigoplus_{c=1}^C V^R_c$ where the $V^R_c$ are independent.
$\bm{V}^R$ is assumed to be unbiased, $E(V_c^R) = Var(\hat{\mu}_c)$ \autocite{pustejovsky_wald_2025}. Additionally, the degrees of freedom for one category (Proof found in Appendix A) is presented here: 
\begin{equation}
   \nu_c = \left[ \sum_{j = 1} ^{Jc} \frac{w^2_{jc}}{ (W_c - w_{jc}) ^2} - \frac{2}{W} \sum_{j = 1} ^{Jc} \frac{w_{jc}^3}{(W_c - w_{jc})^2} + \frac{1}{W_c^2} \left(\sum_{j = 1} ^{Jc} \frac{w_{jc}^2}{W-w_{jc}} \right)^2 \right]^{-1}.
   \label{Eq: nu_c df}
\end{equation}

For the null hypothesis that the overall pooled effects of each category are all equal, $H_0: \mu_1 = \mu_2 = \cdots = \mu_C$, $q=C-1$ is the number of contrasts. The $\mathbf{C}$ contrast matrix in this context has $q \times C$ dimensions and is constructed as $\mathbf{C} = \begin{bmatrix}
    -\mathbf{1}_q & \mathbf{I}_q
\end{bmatrix}$. The null hypothesis can also be written as: $H_0:\mathbf{C}\bm{\mu} = \bm{0}_q$. In this particular case, the Wald statistic becomes:
\begin{equation}
    Q = \hat{\bm{\mu}}'\mathbf{C}'(\mathbf{C} \mathbf{V}^R \mathbf{C}') \mathbf{C}\hat{\bm{\mu}}.
    \nonumber
\end{equation}
The Q statistic and the $\mathbf{D}$ can still be constructed as Equations \ref{eq: Q stat reformulation} and \ref{eq: D matrix}, respectively. However, $\mathbf{z}$ in this context is now $\mathbf{z} = \mathbf{\Omega}^{-1/2}(\mathbf{C}\hat{\mu_c})$ \autocite{pustejovsky_wald_2025}.

\subsection{HTZ Test}

One of the ways \textcite{tipton2015b} approximated the sampling distribution of $\mathbf{D}$ was using a Wishart distribution, where the test statistic would follow Hotelling's $T^2$ distribution. As detailed in Chapter \ref{ch:literaturereview}, the best approach was one derived by \textcite{zhang2012, zhang2013}(Equation, \ref{eq:HTZ_eta}) for special cases of heteroskedastic one-way ANOVA and MANOVA \autocite{tipton2015b}. This approach to find the distribution of Q was to use Hotelling's $T^2$ distribution with $\eta$ degrees of freedom or HTZ-based degrees of freedom (Equation \ref{eq:HTZ_eta}) and is presented again below:
\begin{equation}
    \eta z = \frac{q(q+1)}{\sum_{s=1}^q \sum_{t=1}^q Var(d_{st})},
    \nonumber
\end{equation}
where $d_{st}$ is the entry in row $s$ and column $t$ of $\bm{D}$.

\subsection{Study Level Weights}

For this approximation, we use the study-level weights for the CHE working model that \textcite{vembye2023} presented (Equation \ref{eq: CHEweights-study}). Below are the study-level weights in the context of a categorical moderator with index $c$: 
\begin{equation} \label{eq: CHEweights-study_cat}
    \tilde{w}_{jc} = \frac{k_{jc}}{k_{jc}\hat{\tau}^2 + k_{jc}\rho\sigma_{jc}^2 +\hat{\omega}^2 + (1- \rho)\sigma_{jc}^2}.
\end{equation}.

In this study, I aim to provide a closed-form solution for study-level categorical moderators of the broader derivation presented in \textcite{tipton2015b}, which will be used for power analyses.  


 \section{Moderator with Two Categories}

In this section, I present the Satterthwaite degrees of freedom for a categorical moderator with two categories. For the full derivation, please see Appendix \ref{App: twocat}. Given a moderator with two categories, $C=2$, using a no-intercept model and constraining the regression coefficients to be equal, the $\mathbf{C}$ matrix has $1 \times 2$ dimensions and becomes:
 \begin{equation}
     \mathbf{C} = 
     \begin{bmatrix} 
     -1 & 1 
     \end{bmatrix}
     \nonumber
 \end{equation}
Furthermore, the $\mathbf{C}$ multiplied by the vector of regression coefficients becomes:
 \begin{equation}
     \mathbf{C} \bm{\hat{\beta}}= 
     \begin{bmatrix} 
     -1 & 1 \end{bmatrix}\begin{bmatrix}\bm{\hat{\beta}}_1 \\
     \bm{\hat{\beta}}_2 \end{bmatrix}  = \begin{bmatrix}
         \bm{\hat{\beta}}_2 - \bm{\hat{\beta} }_1
     \end{bmatrix}
     \nonumber
 \end{equation}
 which is set to equal $\begin{bmatrix}
     0 
 \end{bmatrix}$. 

Then, to be able to find the moments of $\mathbf{V}^R$, we need to specify the true variance of $(\mathbf{C}\bm{\hat{\beta}}-\mathbf{c})$. For $C = 2$,  $\mathbf{\Omega}$ is:
 \begin{equation}
     \begin{split}
         \mathbf{\Omega}  &= \mathbf{C}Var(\bm{\hat{\beta}}) \mathbf{C}' \\
    &= \begin{bmatrix}
        Var(\bm{\hat{\beta}}_1) + Var(\bm{\hat{\beta}}_2) 
    \end{bmatrix} 
     \end{split}
     \nonumber
 \end{equation}
For the $\mathbf{z}$ in the $Q$-statistic from Equation \ref{eq: Q stat reformulation}, $\mathbf{z}$ becomes the following when $C=2$: 
 \begin{equation}
    \begin{split}
     \mathbf{z} &= \frac{1}{\sqrt{\frac{1}{W_1} + \frac{1}{W_2}}} \begin{bmatrix}
         \bm{\hat{\mu}}_2 - \bm{\hat{\mu}}_1 
     \end{bmatrix},   \\
    \end{split}
     \nonumber
 \end{equation}
 The normalized variance of the test statistic(scaled by true sampling variance), $\mathbf{D}$ is the following when $C=2$:
 \begin{equation}
    \begin{split}
    \mathbf{D}  & = \frac{V^R_1 + V^R_2 }{\frac{1}{W_1} + \frac{1}{W_2} }
    \end{split} 
    \nonumber
 \end{equation}
Now that we have found $\mathbf{z}$ and $\mathbf{D}$,  the $Q$-statistic (Equation \ref{eq: Q stat reformulation}) reduces to $t^2$-statistic, so the $t$-statistic formulation is as follows:
\begin{equation}
    \begin{split}
         \sqrt{Q} &= t = \frac{\left(\mathbf{\hat{\mu}}_2 - \mathbf{\hat{\mu}}_1  \right)}{\sqrt{\left(V^R_1 + V^R_2 \right)} }. \\
    \end{split}
    \nonumber
\end{equation}

Because the categories are study-level, $V_1^R$ and $V_2^R$ are independent. To find the Satterthwaite degrees of freedom for a categorical moderator with two categories, the moments of $D$ are below:
\begin{equation}
    \begin{split}
        E(D) & = \left(\sum_{c=1}^2 \frac{1}{W_c}  \right)^{-1} \left(E(V^R_1) + E(V^R_2)  \right) \\
         Var(D) & = \left(\sum_{c=1}^2 \frac{1}{W_c}  \right)^{-2 } \left(Var(V^R_1) + Var(V^R_2)  \right). \\
    \end{split}
    \nonumber
\end{equation}

Using the equation for the Satterthwaite degrees of freedom (Equation \ref{eq: satt formulation}), we obtain the Satterthwaite degrees of freedom for a categorical moderator with two categories:
\begin{equation} 
    \begin{split}
        \zeta_{c = 2} & = \frac{2 \times [E(V^R)]^2}{Var(V^R)} \\
              & = \frac{2 \times \left[ \left(E(V^R_1) + E(V^R_2)  \right) \right]^2}{\left(Var(V^R_1) + Var(V^R_2)  \right)} \\
    \end{split}
    \label{eq: two_catdf}
\end{equation}
To simplify this further, we can express Equation \ref{eq: two_catdf} in terms of the degrees of freedom for one category.

The Satterthwaite degrees of freedom for a two-categorical moderator in terms of $\nu_c$ is:
\begin{equation} \label{eq: two_catdf in nu_c df terms2}
    \zeta_{c=2} =
\frac{\left( \frac{1}{W_1} + \frac{1}{W_2} \right)^2}
{\frac{1}{W_1^2 \nu_1} + \frac{1}{W_2^2 \nu_2}}.
\end{equation}

 %%%%%%%%%% general case
\section{Moderator with Multiple Categories} \label{sec: mult categories}

Below are the details of the power approximation for the robust HTZ test. For the derivation of the HTZ approximation for the robust variance estimator when there are multiple categories, please refer to Appendix \ref{App: multiplecat} or \textcite{pustejovsky2024}. In this derivation, $\mathbf{D}$ is redefined since the approximation requires taking the inverse of the $\mathbf{\Omega}^{-1/2}$, which is difficult to do in application. The $\mathbf{z}$ will be defined as: $\mathbf{z} = \mathbf{\Omega}^{-1/2}\mathbf{C}\hat{\mu}_c $ and a new matrix $\bm{G}$ is defined as $\bm{G} = \bm{\Omega}^{-1/2}\mathbf{C} $ therefore substituting in $\bm{G}$, $\bm{D}$ now becomes:
\begin{equation}
    \mathbf{D} = \mathbf{G}\mathbf{V}^R\mathbf{G}'.
\end{equation}

For the cluster-robust Wald test statistic of a study-level categorical moderator with multiple categories, the closed-form solution of the HTZ degrees of freedom for a study-level categorical moderator is:

\begin{equation}
    \label{eq: multiple_categories_satt}
    \eta_z = \frac{C(C+1)}{2\sum_{c=1}^C \frac{1}{\nu_c}\left(1 - \frac{W_c}{\mathbf{W} } \right)^2},
\end{equation}
where $W_c = \sum_{j=1}^{Jc} \tilde{w}_{jc}$, $\tilde{w}_{jc}$ are the study-level weights for the CHE model (Equation \ref{eq: CHEweights-study_cat}), $W = \sum_{c=1}^C W_c$, and $\nu_c$ are the degrees of freedom for category $c$ (Equation \ref{Eq: nu_c df}). Equation \ref{eq: multiple_categories_satt} is equivalent to Equation \ref{eq: two_catdf in nu_c df terms2} when $C=2$. Equation \ref{eq: multiple_categories_satt} will be used as the degrees of freedom for the test of multiple categories that follow a null of $F$-statistic where the degrees of freedom are:  $(d_1 = C-1, d_2 = \eta_z - q +1)$. 

%If $k_j$ and $\sigma_j^2$ are balanced across studies, the study-level weights will be equal across studies. 


% when balance kj and sigma_j_sq. w_jc will all be same. W_c ends up just being j_c (number of studies in category c) a multiple of that. the degrees of freedom per category should be J_c - 1. eta_z becomes a function of c and J_c for the balance kj and sigma_j_sq


%and $\psi_c$ is the expected value of $V^R$ for one category, $\frac{1}{W_c}$.

\subsection{Power for the HTZ Test Based on the CHE+RVE Model} \label{sec: power_multiple}

I assume that the alternative hypothesis follows a non-central F-distribution and has a non-centrality parameter of: 
\begin{equation} \label{eq: NCP}
    \lambda = \sum_{c=1}^C W_c \times (\mu_c - \overline{\mu})^2,
\end{equation}
where $\overline{\mu}$ is the weighted average: $\overline{\mu}_c = \sum_{c=1}^C \frac{(W_c \times \mu_c)}{W}$. Finally, the following equation is used to find the power of the  cluster-robust Wald test using the approximated degrees of freedom:
\begin{equation} \label{eq: power F}
    P(\alpha, \lambda, d_1, d_2) = 1 - F_F(c_{\alpha, d_1, d_2 }| d_1, d_2, \lambda),
\end{equation}
where $F_F(x| d_1, d_2, \lambda)$ is the cumulative distribution function of a non-central F-distribution.

Because I assume that the alternative hypothesis follows non-central F with $d_1$ and $d_2$ degrees of freedom and has the non-centrality parameter from Equation \ref{eq: NCP}, the resulting power estimates using Equation \ref{eq: multiple_categories_satt} are an approximation of the true power of the robust HTZ test. Therefore, it is necessary to evaluate the accuracy of Equation \ref{eq: multiple_categories_satt}. In the next chapter, I detail the methodology of a Monte Carlo simulation I used to validate the power approximation formula.  


